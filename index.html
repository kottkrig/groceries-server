<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    
        var socket;
        
        $(document).ready(function() {
            //var listId = 'a9f87612def3';
            var listId = '8';
            if (localStorage.listId == undefined) {
                getListId();
            } else {
                getList();
            }
            initSocket();
        });
        
        function initSocket() {
            socket = io.connect();
            /*socket.on('connect', function() {
                socket.emit('connectToList', localStorage.listId);
                console.log('Connected to list ' + localStorage.listId);
            });*/
            console.log('Client is running.');
            socket.on('update', function () {
                console.log('Update event Received!');
                getList();
            });
        }
        
        function getListId() {
            $.get('/newList', function(data) {
                console.log("New list created: "+data);
                localStorage.listId = data;
            });
        }
        
        function getList() {
            $.getJSON('/getList', {listId:localStorage.listId}, function(data) {
                $('#list').html("<ul></ul>");
                $.each(data.items, function(key, val) {
                    $('#list ul').append('<li id="' + key + '">' + val + '</li>');
                });
            });
        }
        
        function addItem() {
            $.post('/add', {listId:localStorage.listId, item:$('#addInput').val()}, function(data) {
                socket.emit('listChanged', localStorage.listId);
                getList();
            });
        }
        
        function removeItem() {
            $.post('/remove', {listId:localStorage.listId, item:$('#removeInput').val()}, function(data) {
                socket.emit('listChanged', localStorage.listId);
                getList();
            });
        }
        
        function clearList() {
            $.post('/clearList', {listId:localStorage.listId}, function(data) {
                getList();
            });
        }
        
        function setListId() {
            localStorage.listId = $('#setListInput').val();
            socket.emit('connectToList', localStorage.listId);
            console.log('Connected to list ' + localStorage.listId);
            getList();
        }    
    </script>
	</head>
	<body>
        <form action="/add" method='post'>
            <input id="addInput" type='text' name='item' />
            <button type="button" onClick="addItem(); return false;">Add!</button>
        </form>
        <form action="/remove" method='post'>
            <input id="removeInput" type='text' name='item' />
            <button type="button" onClick="removeItem(); return false;">Remove!</button>
        </form>
        <form action="/clearList" method='post'>
            <input id="clearListInput" type='text' name='listId' />
            <button type="button" onClick="clearList(); return false;">ClearList</button>
        </form>
        <form>
            <input id="setListInput" type='text'/>
            <button type="button" onClick="setListId(); return false;">SetListId</button>
        </form>
        <div>
            <p id="list"></p>
        </div>
	</body>
</html>