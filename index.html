<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket;
        var listUri = '/list';
        
        $(document).ready(function() {
            //var listId = 'a9f87612def3';
            var listId = '8';
            if (localStorage.listId == undefined)
                getListId();
            else
                getList();
            initSocket();
        });
        
        function initSocket() {
            socket = io.connect();
            console.log('Client is running.');
            socket.on('update', function () {
                console.log('Update event Received!');
                getList();
            });
            
            socket.on('message', function(message) {
                console.log('Got message: ' + message);    
            });
        }
        function getListId() {
            $.post(listUri, function(data) {
                console.log("New list created: "+data);
                localStorage.listId = data;
            });
        }
        
        function getList() {
            var url = listUri + '/' + localStorage.listId;
            $.getJSON(url, function(data) {
                $('#list').html("<ul></ul>");
                $.each(data.items, function(key, val) {
                    $('#list ul').append('<li id="' + key + '">' + val + '</li>');
                });
            });
        }
        
        function addItem() {
            var url = listUri + '/' + localStorage.listId;
            $.post(url, {item:$('#addInput').val()}, function(data) {
                console.log('Added item to list');
            });
        }
        
        function removeItem() {
            var url = listUri + '/' + localStorage.listId + '/' + $('#removeInput').val();
            $.ajax({
                type: 'DELETE',
                url: url,
                success: function(msg) {
                    console.log('Removed item from list');
                }
            });
        }
        
        function clearList() {
            var url = listUri + '/' + localStorage.listId;
            $.ajax({
                type: 'DELETE',
                url: url,
                success: function(msg) {
                    console.log('Cleared list');
                }
            });
        }
        
        function setListId() {
            localStorage.listId = $('#setListInput').val();
            socket.emit('connectToList', localStorage.listId);
            console.log('Connected to list ' + localStorage.listId);
            getList();
        }    
    </script>
	</head>
	<body>
        <form action="/add" method='post'>
            <input id="addInput" type='text' name='item' />
            <button type="button" onClick="addItem(); return false;">Add!</button>
        </form>
        <form action="/remove" method='post'>
            <input id="removeInput" type='text' name='item' />
            <button type="button" onClick="removeItem(); return false;">Remove!</button>
        </form>
        <form>
            <input id="setListInput" type='text'/>
            <button type="button" onClick="setListId(); return false;">SetListId</button>
        </form>
        <form>
            <button type="button" onClick="clearList(); return false;">ClearList</button>
        </form>
        <div>
            <p id="list"></p>
        </div>
	</body>
</html>